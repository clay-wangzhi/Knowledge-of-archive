## 八、常用模块的使用

### 1、日志模块

#### ngx_http_log_module

模块以指定的格式写入请求日志

#### （1）、log_format name string ...;

string可以使用nginx核心模块及其它模块内嵌的变量；

#### （2）、access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]];

access_log off;#关闭日志记录

```bash
server{
.....
access_log /var/log/nginx/vhost1_access.log main;   # 自定义日志路径，格式为main
location /ngxstatus {
stub_status;
access_log off;#关闭访问信息页日志记录
}
}
```

访问日志文件路径，格式及相关的缓冲的配置；
buffer=size
flush=time

#### （3）、open_log_file_cache max=N [inactive=time] [min_uses=N] [valid=time];

open_log_file_cache off;
缓存各日志文件相关的元数据信息；

max：缓存的最大文件描述符数量；
min_uses：在inactive指定的时长内访问大于等于此值方可被当作活动项；
inactive：非活动时长；
valid：验正缓存中各缓存项是否为活动项的时间间隔；

### 3、ssl安全套接字模块：

#### ngx_http_ssl_module

- （1）、 ssl on | off;
  是否启用ssl
- （2）、ssl_certificate file;
  当前虚拟主机使用PEM格式的证书文件；
- （3）、ssl_certificate_key file;
  当前虚拟主机上与其证书匹配的私钥文件；

```csharp
在CA证书服务器生成自签证书
[root@C711 ~]# cd /etc/pki/CA/
[root@C711 CA]# ls
certs  crl  newcerts  private
[root@C711 CA]# (umask 077;openssl genrsa -out private/cakey.pem 2048)
Generating RSA private key, 2048 bit long modulus
...........+++
......+++
e is 65537 (0x10001)
[root@C711 CA]# ll private
总用量 4
-rw------- 1 root root 1675 7月   9 23:02 cakey.pem
[root@C711 CA]# openssl req -new -x509 -key private/cakey.pem -out cacert.pm
[root@C711 CA]# touch index.txt
[root@C711 CA]# echo 01 > serial

在nginx服务器上：
[root@C712 ~]# mkdir /etc/nginx/ssl  #创建ssl目录
[root@C712 ~]# cd /etc/nginx/ssl
[root@C712 ssl]# (umask 077; openssl genrsa -out nginx.key 2048)      #创建秘钥
[root@C712 ssl]# ll   #查询
总用量 4
-rw------- 1 root root 1679 7月   9 23:19 nginx.key
[root@C712 ssl]# openssl req -new -key nginx.key -out nginx.csr #创建私钥
[root@C712 ssl]# ll  #查询
总用量 8
-rw-r--r-- 1 root root  989 7月   9 23:22 nginx.csr
-rw------- 1 root root 1679 7月   9 23:19 nginx.key
[root@C712 ssl]# scp nginx.csr 192.168.1.11:/tmp/#传输到CA服务器上

在CA服务器上认证
[root@C711 CA]# openssl ca -in /tmp/nginx.csr -out /etc/pki/CA/certs/nginx.crt -days 365
[root@C711 CA]#scp certs/nginx.crt 192.168.1.12:/etc/nginx/ssl   #传送回nginx服务器

回到nginx服务器上
[root@C712 ~]# cd /etc/nginx
[root@C712 nginx]# cp conf.d/vhost1.conf  conf.d/vhost1_ssl.conf 
[root@C712 nginx]# vim conf.d/vhost1_ssl.conf 

server{
       listen 443 ssl;   #修改监听端口
       server_name www.ilinux.io;
       root /data/nginx/vhost1;
       access_log /var/log/nginx/vhost1_ssl_access.log main;

ssl on;                                              #开启ssl
ssl_certificate /etc/nginx/ssl/nginx.crt;
ssl_certificate_key /etc/nginx/ssl/nginx.key;
ssl_protocols sslv3 tlsv1 tlsv1.1 tlsv1.2;#支持哪些协议
ssl_session_cache shared:sslcache:20m;#指明缓存大小，1M能够缓存4000个会话

location ~* ^/(admin|login){
      auth_basic "admin area or login url";
      auth_basic_user_file /etc/nginx/.ngxpasswd;
}
}
[root@C712 ~]# nginx -s reload
```

- （4）、ssl_protocols [SSLv2] [SSLv3] [TLSv1] [TLSv1.1] [TLSv1.2];
  支持ssl协议版本，默认为后三个；
- （5）、ssl_session_cache off | none | [builtin[:size]] [shared:name:size];

> builtin[:size]：使用OpenSSL内建的缓存，此缓存为每worker进程私有；

> [shared:name:size]：在各worker之间使用一个共享的缓存；

- 6、ssl_session_timeout time;
  客户端一侧的连接可以复用ssl session cache中缓存 的ssl参数的有效时长；

### 4、URL重定向模块：

#### ngx_http_rewrite_module

URL重定向，URL重写查找替换

> 例如：
> [bbs.magedu.com/](http://bbs.magedu.com/) --> [www.magedu.com/bbs/](http://www.magedu.com/bbs/), http://www.magedu.com/ --> https://www.magedu.com/
> http://www.magedu.com/login.php;username=tom --> http://www.magedu.com/tom/
> http://www.ilinux.io/bbs/ --> http://bbs.ilinux.io/

将用户请求的URI基于regex所描述的模式进行检查，而后完成替换；

- （1）、rewrite regex replacement [flag]
  将用户请求的URI基于regex所描述的模式进行检查，匹配到时将其替换为replacement指定的新的URI；

```ruby
[root@C712 nginx]# vim /etc/nginx/conf.d/vhost1.conf 

server{
       listen 8080;
       server_name www.ilinux.io;
       root /data/nginx/vhost1;
       rewrite /(.*)\.png$ /$1.jpg;#请求png返回jpg
       rewrite  /(.*)$ https://www.ilinux.io/$1#URL的8080请求都要自动重定向到https上
```

- 注意：如果在同一级配置块中存在多个rewrite规则，那么会自下而下逐个检查；被某条件规则替换完成后，会重新一轮的替换检查，因此，隐含有循环机制；[flag]所表示的标志位用于控制此循环机制；
- 如果replacement是以http://或https://开头，则替换结果会直接以重向返回给客户端；
- 301：永久重定向；
- [flag]标志位：

> last：（循环）
> 重写完成后停止对当前URI在当前location中后续的其它重写操作，而后对新的URI启动新一轮重写检查；提前重启新一轮循环；
> break：（跳出循环）
> 重写完成后停止对当前URI在当前location中后续的其它重写操作，而后直接跳转至重写规则配置块之后的其它配置；结束循环；
> redirect：
> 重写完成后以临时重定向方式直接返回重写后生成的新URI给客户端，由客户端重新发起请求；不能以http://或https://开头；
> permanent:
> 重写完成后以永久重定向方式直接返回重写后生成的新URI给客户端，由客户端重新发起请求；

- （2）、return返回
  return code [text];
  return code URL;
  return URL;
  停止处理并将指定的代码返回给客户端。
- （3）、 rewrite_log on | off;
  是否开启重写日志；
- （4）、 if (condition) { ... }条件判断
  引入一个新的配置上下文 ；条件满足时，执行配置块中的配置指令；server, location；

> condition：
> 比较操作符：
> ==
> !=
> ~：模式匹配，区分字符大小写；
> ~*：模式匹配，不区分字符大小写；!~：模式不匹配，区分字符大小写；!~*：模式不匹配，不区分字符大小写；
> 文件及目录存在性判断：
> -e, !-e
> -f, !-f
> -d, !-d
> -x, !-x

- （5）、set $variable value;
  用户自定义变量 ；

### 5、允许引用模块：

#### ngx_http_referer_module

网站的合法引用，防止盗链

- 格式：valid_referers none | blocked | server_names | string ...;
- 定义referer首部的合法可用值；

> none：请求报文首部没有referer首部；
> blocked：请求报文的referer首部没有值；
> server_names：参数，其可以有值作为主机名或主机名模式；
> arbitrary_string：直接字符串，但可使用*作通配符；regular expression：被指定的正则表达式模式匹配到的字符串；要使用~打头，例如 ~.*.magedu.com；

```ruby
配置示例：
valid_referers none block server_names *.magedu.com *.mageedu.com magedu.* mageedu.* ~\.magedu\.;#匹配指定URL

if($invalid_referer) {
return http://www.magedu.com/invalid.jpg; #非法引用自动跳转到指定URl
}
```



