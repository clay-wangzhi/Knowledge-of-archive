(window.webpackJsonp=window.webpackJsonp||[]).push([[256],{962:function(s,e,a){"use strict";a.r(e);var n=a(1),t=Object(n.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"安装-jenkins"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-jenkins"}},[s._v("#")]),s._v(" 安装 jenkins")]),s._v(" "),a("h2",{attrs:{id:"使用-ansible-安装-jenkins"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-ansible-安装-jenkins"}},[s._v("#")]),s._v(" 使用 ansible 安装 jenkins")]),s._v(" "),a("blockquote",[a("p",[s._v("经实验：ansible 2.7.10版本可以安装 jenkins 2.210版本")]),s._v(" "),a("p",[s._v("安装更高版本，请一并升级ansible，低版本ansible在安装插件时会报如下错误：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('{"attempts": 5, "changed": false, "details": "HTTP Error 403: Forbidden", "item": "ansible", "msg": "Cannot install plugin."}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("p",[a("strong",[s._v("ansible安装jenkins")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("ansible-galaxy "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" clay_wangzhi.jenkins\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("galaxy中有详细的文档说明：")]),s._v(" "),a("blockquote",[a("p",[s._v("链接地址：https://galaxy.ansible.com/clay_wangzhi/jenkins")])]),s._v(" "),a("p",[s._v("额外注意一些插件的安装：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Role-based Authorization Strategy  #权限控制插件\ngit-parameter\nPublish Over SSH\nDIngDIng\ngit-parameter #选项参数增加，git-brach选项\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h2",{attrs:{id:"使用docker安装jenkins"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用docker安装jenkins"}},[s._v("#")]),s._v(" 使用docker安装jenkins")]),s._v(" "),a("h3",{attrs:{id:"安装配置docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装配置docker"}},[s._v("#")]),s._v(" 安装配置docker")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("更换yum源，如果本来就是国内源，无需更换")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -fsSL "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://gitee.com/clay-wangzhi/shell/raw/master/repo_replace.sh"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("安装配置Docker")]),s._v(" "),a("p",[s._v("使用官方脚本安装 Docker")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -fsSL "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://get.docker.com/"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" -s -- --mirror Aliyun\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("加载br_netfilter")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("modprobe br_netfilter\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("设置下系统内核参数")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("cat"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF"),a("span",{pre:!0,attrs:{class:"token bash punctuation"}},[s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/sysctl.d/docker.conf")]),s._v("\n# 要求iptables不对bridge的数据进行处理\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-arptables = 1\n# 开启转发\nnet.ipv4.ip_forward = 1\nEOF")]),s._v("\nsysctl -p /etc/sysctl.d/docker.conf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("blockquote",[a("p",[s._v("⚠️ 慎用"),a("code",[s._v("sysctl --system")]),s._v("命令，如果参数在不同文件中设置，会有优先级问题，目前看来"),a("code",[s._v("/etc/sysctl.conf")]),s._v("的优先级最高")])]),s._v(" "),a("p",[s._v("配置docker镜像加速器")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -sSL https://get.daocloud.io/daotools/set_mirror.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" -s http://f1361db2.m.daocloud.io\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("启动docker服务并加入开机自启")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" docker "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl start docker\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])]),s._v(" "),a("h3",{attrs:{id:"安装配置nginx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装配置nginx"}},[s._v("#")]),s._v(" 安装配置nginx")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("新增nginx yum源")]),s._v(" "),a("p",[s._v("To set up the yum repository, create the file named "),a("code",[s._v("/etc/yum.repos.d/nginx.repo")]),s._v(" with the following contents:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("[nginx-stable]\nname=nginx stable repo\nbaseurl=http://nginx.org/packages/centos/$releasever/$basearch/\ngpgcheck=1\nenabled=1\ngpgkey=https://nginx.org/keys/nginx_signing.key\nmodule_hotfixes=true\n\n[nginx-mainline]\nname=nginx mainline repo\nbaseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/\ngpgcheck=1\nenabled=0\ngpgkey=https://nginx.org/keys/nginx_signing.key\nmodule_hotfixes=true\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("安装&&启动nginx")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("yum -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" nginx\nnginx\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("配置hosts解析")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1 www.google.com"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/hosts\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])]),s._v(" "),a("h3",{attrs:{id:"安装配置jenkins"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装配置jenkins"}},[s._v("#")]),s._v(" 安装配置jenkins")]),s._v(" "),a("blockquote",[a("p",[s._v("⚠️ 执行此步骤前，需要先安装配置nginx，在container启动时network设置为host时，我更新主机的hosts文件后，发现容器内的hosts文件没有更新，当前docker版本为20.10.6")])]),s._v(" "),a("ol",[a("li",[a("p",[s._v("下载jenkins镜像")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker pull jenkinsci/blueocean:1.24.6\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("创建挂载目录")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /opt/jenkins-data\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("创建并启动jenkins")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker run -u root --rm -d -e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("JAVA_OPTS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("-Duser.timezone"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Asia/Shanghai --mount "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bind,source"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/opt/jenkins-data,target"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/jenkins_home --network"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("host --name jenkins jenkinsci/blueocean:1.24.6\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("剩下的步骤按着提示完成就行，安装配置nginx的原因如下：")]),s._v(" "),a("p",[s._v("输入密码后第二步报”该Jenkins实例似乎已离线“，网上搜方案有两种：")]),s._v(" "),a("p",[s._v("1）更改插件下载源，具体步骤如下：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入http://ip:8080/jenkins/pluginManager/advanced")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将最下面的 Update Site 的 URL 地址替换成：http://mirror.esuni.jp/jenkins/updates/update-center.json")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 点“submit”按钮，然后点右下角角 “check now”")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 然后输入地址 http://ip:8080/jenkins/restart 重启 jenkins 后再重新安装插件")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("2）修改 /var/lib/jenkins/updates/default.json 文件中的 connectionCheckUrl 项值为国内可访问的地址。")]),s._v(" "),a("p",[s._v("经实验，两种方式都不能保证100% 初始化成功")]),s._v(" "),a("p",[s._v("方法一更新的是插件的下载源，但是我还没开始下载插件，只是下载插件前的检查网络；")]),s._v(" "),a("p",[s._v("方法二重启jenkins又被重置为谷歌域名。")]),s._v(" "),a("p",[s._v("考虑connectionCheckUrl 只是用来安装插件时检查网络是否ping通，因此直接在本机上给www.google.com 指向到本地，再给配一个nginx 响应即可")])])])])}),[],!1,null,null,null);e.default=t.exports}}]);