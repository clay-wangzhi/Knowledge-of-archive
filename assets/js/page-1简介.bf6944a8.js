(window.webpackJsonp=window.webpackJsonp||[]).push([[121],{655:function(s,a,n){"use strict";n.r(a);var e=n(1),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"_1-简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[s._v("#")]),s._v(" 1 简介")]),s._v(" "),n("p",[s._v("之所以专门说一说这个模块，是因为lineinfile在实际使用中非常有用。")]),s._v(" "),n("p",[s._v("lineinfile模块用于在源文件中插入、删除、替换行，和sed命令的功能类似，也支持正则表达式匹配和替换。")]),s._v(" "),n("p",[s._v("实际上，在大多数时候，我们在linux上的操作，就是针对文件的操作，通过配置管理工具对配置文件作统一的配置修改是一个非常酷的功能。")]),s._v(" "),n("p",[s._v("下面是官方针对该模块的说明：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("lineinfile - Ensure a particular line is in a file, or replace an existing line using a back-referenced regular expression\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("简单讲，这个模块就是针对一个文件中行内容的操作。")]),s._v(" "),n("p",[s._v("下面我们详细说一说其具体可以做的事情。")]),s._v(" "),n("h2",{attrs:{id:"_2-修改匹配行"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-修改匹配行"}},[s._v("#")]),s._v(" 2 修改匹配行")]),s._v(" "),n("p",[s._v("下面是一个简单的task示例：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将/etc/selinux/config中匹配到以'SELINUX='开头的行，将其替换为'SELINUX=disabled'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" modify selinux to disabled\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lineinfile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/selinux/config\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'^SELINUX='")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("line")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'SELINUX=disabled'")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h2",{attrs:{id:"_3-在匹配行前或后添加内容"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-在匹配行前或后添加内容"}},[s._v("#")]),s._v(" 3 在匹配行前或后添加内容")]),s._v(" "),n("blockquote",[n("p",[s._v("insertbefore和insertafter指定的正则表达式如果匹配了多行，则默认选中最后一个匹配行，然后在被选中的行前、行后插入。如果明确要指定选中第一次匹配的行，则指定参数firstmatch=yes：")])]),s._v(" "),n("p",[s._v("示例文件如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# cat /etc/http.conf\n\nListen 127.0.0.1:80\nListen 80\nPort\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"_3-1-在匹配行前添加"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-在匹配行前添加"}},[s._v("#")]),s._v(" 3.1 在匹配行前添加")]),s._v(" "),n("p",[s._v("在http.conf文件的"),n("code",[s._v("Listen 80")]),s._v("前面添加一行"),n("code",[s._v("Listen 8080")]),s._v("，task示例如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- name: add line before Listen 80\n  lineinfile:\n    dest: /etc/http.conf\n    insertbefore: '^Listen 80'\n    line: 'Listen 8080'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"_3-2-在匹配行后添加"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-在匹配行后添加"}},[s._v("#")]),s._v(" 3.2 在匹配行后添加")]),s._v(" "),n("p",[s._v("在http.conf文件的"),n("code",[s._v("Port")]),s._v("后面添加一行"),n("code",[s._v("just a test")]),s._v("，task示例如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- name: add line before Listen 80\n  lineinfile:\n    dest: /etc/http.conf\n    insertafter: '^Port'\n    line: 'just a test'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h2",{attrs:{id:"_4-修改文件内容及权限"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-修改文件内容及权限"}},[s._v("#")]),s._v(" 4 修改文件内容及权限")]),s._v(" "),n("p",[s._v("示例文件：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat /etc/hosts")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1       localhost.localdomain localhost ::1       localhost6.localdomain6 localhost6\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.1")]),s._v(".61.130     hub.dz11.com\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("修改/etc/hosts，将以"),n("code",[s._v("127.0.0.1")]),s._v("开头的行替换为"),n("code",[s._v("127.0.0.1 localhost")]),s._v("，并将/etc/hosts的属主和属组都修改为root，权限改为644，如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- name: modify hosts\n  lineinfile:\n    dest: /etc/hosts\n    regex: '^127\\.0\\.0\\.1'\n    line: '127.0.0.1 localhost'\n    owner: root\n    group: root\n    mode: 0644\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("h2",{attrs:{id:"_5-删除行内容"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-删除行内容"}},[s._v("#")]),s._v(" 5 删除行内容")]),s._v(" "),n("p",[s._v("regexp结合state=absent时，表示删除所有匹配的行。")]),s._v(" "),n("p",[s._v("示例原文件：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat /etc/hosts")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1       localhost.localdomain localhost ::1       localhost6.localdomain6 localhost6\n"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.1")]),s._v(".61.130     hub.dz11.com\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("删除以"),n("code",[s._v("10.1.61.130")]),s._v("开头的行：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- name: delete a line\n  lineinfile:\n    dest: /etc/hosts\n    regex: '^10\\.1\\.61'\n    state: absent\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h2",{attrs:{id:"_6-文件存在则添加一行内容"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-文件存在则添加一行内容"}},[s._v("#")]),s._v(" 6 文件存在则添加一行内容")]),s._v(" "),n("p",[s._v("往/etc/hosts里添加一行"),n("code",[s._v("10.1.61.131 test.dz11.com")]),s._v("（多次执行，不会重复添加），示例如下：")]),s._v(" "),n("p",[s._v("如果再次执行，则不会再次追加此行。因为lineinfile模块的state参数默认值为present，它能保证幂等性，当要插入的行已经存在时则不会再插入。")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" add a line\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lineinfile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/hosts\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("line")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.1.61.131 test.dz11.com'")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h2",{attrs:{id:"_7-如果有匹配的行则修改该行-如果不匹配则添加"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-如果有匹配的行则修改该行-如果不匹配则添加"}},[s._v("#")]),s._v(" 7 如果有匹配的行则修改该行，如果不匹配则添加")]),s._v(" "),n("p",[s._v("示例原文件/tmp/test.txt内容如下：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# %wheel   ALL=(ALL)   ALL")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("下面的示例task中，匹配以"),n("code",[s._v("%wheel")]),s._v("开头的行，匹配到，则执行替换，未匹配，则添加。因为原文件中，没有以"),n("code",[s._v("%wheel")]),s._v("开头的行，所以会添加一行：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" add or modify a line\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lineinfile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /tmp/test.txt\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'^%wheel'")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("line")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%wheel  ALL=(ALL)       NOPASSWD: ALL'")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("修改后的文件如下：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#cat /tmp/text.txt")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# %wheel   ALL=(ALL)   ALL")]),s._v("\n%wheel  "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ALL")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ALL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("       NOPASSWD: ALL\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h2",{attrs:{id:"_8-参数backrefs-backup说明"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-参数backrefs-backup说明"}},[s._v("#")]),s._v(" 8 参数backrefs，backup说明")]),s._v(" "),n("ul",[n("li",[s._v("backup： 是否备份原文件，默认为no")]),s._v(" "),n("li",[s._v("backrefs：\n"),n("ul",[n("li",[s._v("当backrefs为no时，如果regex没有匹配到行，则添加一行，如果Regx匹配到行，则修改该行")]),s._v(" "),n("li",[s._v("当backrefs为yes时，如果regex没有匹配到行，则保持原文件不变，如果regex匹配到行，则修改该行")]),s._v(" "),n("li",[s._v("backrefs默认为no，所以上面那个示例中，我们没有配置backrefs，而默认没有匹配，则修改。")])])])]),s._v(" "),n("p",[s._v("下面我们看一看backrefs为yes时匹配到行的示例：")]),s._v(" "),n("p",[s._v("示例原文件：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /tmp/testfile")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# %wheel   ALL=(ALL)   ALL")]),s._v("\n%wheel  "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ALL")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ALL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("       NOPASSWD: ALL\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#?bar")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("task示例：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(" - name: test backrefs\n  lineinfile:\n      backup: yes\n      state: present\n      dest: /tmp/testfile\n      regexp: '^#\\?bar'\n      backrefs: yes\n      line: 'bar'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("修改后的文件：")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /tmp/testfile")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# %wheel   ALL=(ALL)   ALL")]),s._v("\n%wheel  "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ALL")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ALL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("       NOPASSWD: ALL\nbar\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h2",{attrs:{id:"_9-使用validate验证文件是否正确修改"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_9-使用validate验证文件是否正确修改"}},[s._v("#")]),s._v(" 9 使用validate验证文件是否正确修改")]),s._v(" "),n("p",[s._v("在一些场景下，我们修改完文件后，需要对文件做一下测试，用以检查文件修改之后，是否能正常运行。如http.conf、nginx.conf等，一旦改错，而不加以测试，可能会直接导致http服务挂掉。")]),s._v(" "),n("p",[s._v("可以使用validate关键字，在修改完成以后，对文件执行检测：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- name: test validate\n  lineinfile:\n      dest: /etc/sudoers\n      state: present\n      regexp: '^%ADMIN ALL='\n      line: '%ADMIN ALL=(ALL)'\n      validate: 'visudo -cf %s'\n  tags:\n    - testsudo\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("h2",{attrs:{id:"_10-regexp和insertxxx结合"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_10-regexp和insertxxx结合"}},[s._v("#")]),s._v(" 10 regexp和insertXXX结合")]),s._v(" "),n("p",[s._v("lineinfile最后一个比较常用的功能是regepx结合insertbefore或结合insertafter。这时候的行将根据insertXXX的位置来插入，而regexp参数则充当幂等性判断参数：只有regepx匹配失败时，insertXXX才会插入行。")]),s._v(" "),n("p",[s._v("例如：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- lineinfile:\npath: \"a.txt\"\nline: \"hello line\"\nregexp: '^hello'\ninsertbefore: '^para.* 2'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v('这表示将"hello line"插入在paragraph 2行的前面，但如果再次执行，则不会再次插入，因为regexp参数指定的正则表达式已经能够已经存在的"hello line"行。所以，当regepx结合insertXXX使用时，regexp的参数通常都会设置为能够匹配插入之后的行的正则表达式，以便实现幂等性。')]),s._v(" "),n("blockquote",[n("p",[s._v("参考链接：")]),s._v(" "),n("p",[s._v("https://www.cnblogs.com/breezey/p/9297252.html")]),s._v(" "),n("p",[s._v("https://blog.51cto.com/cloumn/blog/1544")])])])}),[],!1,null,null,null);a.default=t.exports},658:function(s,a,n){"use strict";n.r(a);var e=n(1),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"_1-简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[s._v("#")]),s._v(" 1 简介")]),s._v(" "),n("p",[s._v("我们在编写playbook的时候，不可避免的要执行一些重复性操作，比如指安装软件包，批量创建用户，操作某个目录下的所有文件等。正如我们所说，ansible一门简单的自动化语言，所以流程控制、循环语句这些编程语言的基本元素它同样都具备。")]),s._v(" "),n("p",[s._v("loop循环，它是在Ansible 2.5版本中新添加的循环结构，等价于with_list。大多数时候，with_xxx的循环都可以通过一定的手段转换成loop循环，所以从Ansible 2.5版本之后，原来经常使用的with_items循环都可以尝试转换成loop。")]),s._v(" "),n("p",[s._v("下面我们简单的说一说Playbook中循环语句。")]),s._v(" "),n("h2",{attrs:{id:"_2-loop关键字说明"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-loop关键字说明"}},[s._v("#")]),s._v(" 2 loop关键字说明")]),s._v(" "),n("p",[s._v("在playbook中使用循环，直接使用loop关键字即可。")]),s._v(" "),n("p",[s._v("如下示例，启动httpd和postfilx服务：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('tasks:\n  - name: postfix and httpd are running\n    service:\n      name: "{{ item }}"\n      state: started\n    loop:\n      - postfix\n      - httpd\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("也可以将loop循环的列表提前赋值给一个变量，然后在循环语句中调用：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('#cat test_services.yml\ntest_services:\n  - postfix\n  - httpd\n\n# cat install_pkgs.yml \n- name: start services\n  hosts: test\n  vars_files:\n    - test_services.yml\n  tasks:\n    - name: postfix and httpd are running\n      service:\n        name: "{{ item }}"\n        state: started\n      loop: "{{ test_services }}"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("下面是一个循环更复杂类型数据的示例：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# cat test_loop.yml \n- name: test loop\n  hosts: test\n  tasks:\n  - name: add www group\n    group: \n      name: www\n  - name: add several users\n    user: \n      name: \"{{ item.name }}\"\n      state: present \n      groups: \"{{ item.groups }}\"\n    loop:\n      - { name: 'testuser1', groups: 'wheel' }\n      - { name: 'testuser2', groups: 'www' }\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("h2",{attrs:{id:"_3-循环的控制-loop-control"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-循环的控制-loop-control"}},[s._v("#")]),s._v(" 3 循环的控制：loop_control")]),s._v(" "),n("p",[s._v("后续补充")]),s._v(" "),n("h2",{attrs:{id:"_3-在循环语句中注册变量"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-在循环语句中注册变量"}},[s._v("#")]),s._v(" 3 在循环语句中注册变量")]),s._v(" "),n("p",[s._v("下面是一个register的变量在循环中使用的例子：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# cat register_loop.yml \n- name: registered variable usage as a loop list\n  hosts: test\n  tasks:\n      - name: ensure /mnt/bkspool exists\n        file:\n          path: /mnt/bkspool\n          state: directory\n      - name: retrieve the list of home directories\n        command: ls /home\n        register: home_dirs\n      - name: Show home_dirs results\n        debug:\n          var: home_dirs.stdout_lines\n      - name: add home dirs to the backup spooler\n        file: \n          path: /mnt/bkspool/{{ item }}\n          src: /home/{{ item }}\n          state: link\n          force: yes\n        loop: "{{ home_dirs.stdout_lines }}"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("p",[s._v("在循环语句中注册变量：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- name: Loop Register test\n  gather_facts: no\n  hosts: test\n  tasks:\n    - name: Looping Echo Task\n      shell: "echo this is my item: {{ item }}"\n      loop:\n        - one\n        - two\n      register: echo_results\n    - name: Show echo_results variable\n      debug:\n        var: echo_results\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("执行语句，可以看到变量的返回结果为一个字典列表：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('ok: [10.1.61.187] => {\n    "echo_results": {\n        "changed": true,\n        "msg": "All items completed",\n        "results": [\n            {\n                "ansible_loop_var": "item",\n                "changed": true,\n                "cmd": "echo this is my item: one",\n                "delta": "0:00:00.004905",\n                "end": "2019-06-10 00:23:51.814151",\n                "failed": false,\n                "invocation": {\n                    "module_args": {\n                        "_raw_params": "echo this is my item: one",\n                        "_uses_shell": true,\n                        "argv": null,\n                        "chdir": null,\n                        "creates": null,\n                        "executable": null,\n                        "removes": null,\n                        "stdin": null,\n                        "stdin_add_newline": true,\n                        "strip_empty_ends": true,\n                        "warn": true\n                    }\n                },\n                "item": "one",\n                "rc": 0,\n                "start": "2019-06-10 00:23:51.809246",\n                "stderr": "",\n                "stderr_lines": [],\n                "stdout": "this is my item: one",\n                "stdout_lines": [\n                    "this is my item: one"\n                ]\n            },\n            {\n                "ansible_loop_var": "item",\n                "changed": true,\n                "cmd": "echo this is my item: two",\n                "delta": "0:00:00.004736",\n                "end": "2019-06-10 00:23:52.008981",\n                "failed": false,\n                "invocation": {\n                    "module_args": {\n                        "_raw_params": "echo this is my item: two",\n                        "_uses_shell": true,\n                        "argv": null,\n                        "chdir": null,\n                        "creates": null,\n                        "executable": null,\n                        "removes": null,\n                        "stdin": null,\n                        "stdin_add_newline": true,\n                        "strip_empty_ends": true,\n                        "warn": true\n                    }\n                },\n                "item": "two",\n                "rc": 0,\n                "start": "2019-06-10 00:23:52.004245",\n                "stderr": "",\n                "stderr_lines": [],\n                "stdout": "this is my item: two",\n                "stdout_lines": [\n                    "this is my item: two"\n                ]\n            }\n        ]\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br")])]),n("h2",{attrs:{id:"_4-旧循环语句"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-旧循环语句"}},[s._v("#")]),s._v(" 4 旧循环语句")]),s._v(" "),n("p",[s._v("在Ansible 2.5以前，playbook通过不同的循环语句以实现不同的循环，这些语句使用"),n("code",[s._v("with_")]),s._v("作为前缀。这些语法目前仍然兼容，但在未来的某个时间点，会逐步废弃。")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("循环语句关键字")]),s._v(" "),n("th",[s._v("描述")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("with_items")]),s._v(" "),n("td",[s._v("简单的列表循环")])]),s._v(" "),n("tr",[n("td",[s._v("with_nested")]),s._v(" "),n("td",[s._v("嵌套循环")])]),s._v(" "),n("tr",[n("td",[s._v("with_dict")]),s._v(" "),n("td",[s._v("循环字典")])]),s._v(" "),n("tr",[n("td",[s._v("with_fileglob")]),s._v(" "),n("td",[s._v("循环指定目录中的所有文件")])]),s._v(" "),n("tr",[n("td",[s._v("with_lines")]),s._v(" "),n("td",[s._v("循环一个文件中的所有行")])]),s._v(" "),n("tr",[n("td",[s._v("with_sequence")]),s._v(" "),n("td",[s._v("生成一个自增的整数序列，可以指定起始值和结束值以及步长。参数以key=value的形式指定，format指定输出的格式。数字可以是十进制、十六进制、八进制")])]),s._v(" "),n("tr",[n("td",[s._v("with_subelement")]),s._v(" "),n("td",[s._v("遍历子元素")])]),s._v(" "),n("tr",[n("td",[s._v("with_together")]),s._v(" "),n("td",[s._v("遍历数据并行集合")])])])]),s._v(" "),n("h3",{attrs:{id:"_4-1-with-items"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-with-items"}},[s._v("#")]),s._v(" 4.1 with_items")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: test\n  vars:\n    data:\n      - user0\n      - user1\n      - user2\n  tasks:\n    - name: "with_items"\n      debug:\n        msg: "{{ item }}"\n      with_items: "{{ data }}"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("h3",{attrs:{id:"_4-2-with-nested"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-with-nested"}},[s._v("#")]),s._v(" 4.2 with_nested")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("tasks: \n  - name: debug loops\n    debug: msg=\"name is {{ item[0] }}  vaule is {{ item[1] }} num is {{ item[2] }}\"\n    with_nested:\n      - ['alice','bob']\n      - ['a','b','c']\n      - ['1','2','3']\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("item[0]是循环的第一个列表的值['alice','bob']。item[1]是第二个列表的值；item[2]则是第三个列表的值，以上的执行输出如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# ansible-playbook with_nested_ex.yml \n\nPLAY [with_nested test] ******************************************************************************************\n\nTASK [Gathering Facts] *******************************************************************************************\nok: [10.1.61.187]\n\nTASK [debug loops] ***********************************************************************************************\nok: [10.1.61.187] => (item=['alice', 'a', '1']) => {\n    \"msg\": \"name is alice  vaule is a num is 1\"\n}\nok: [10.1.61.187] => (item=['alice', 'a', '2']) => {\n    \"msg\": \"name is alice  vaule is a num is 2\"\n}\nok: [10.1.61.187] => (item=['alice', 'a', '3']) => {\n    \"msg\": \"name is alice  vaule is a num is 3\"\n}\nok: [10.1.61.187] => (item=['alice', 'b', '1']) => {\n    \"msg\": \"name is alice  vaule is b num is 1\"\n}\nok: [10.1.61.187] => (item=['alice', 'b', '2']) => {\n    \"msg\": \"name is alice  vaule is b num is 2\"\n}\nok: [10.1.61.187] => (item=['alice', 'b', '3']) => {\n    \"msg\": \"name is alice  vaule is b num is 3\"\n}\nok: [10.1.61.187] => (item=['alice', 'c', '1']) => {\n    \"msg\": \"name is alice  vaule is c num is 1\"\n}\nok: [10.1.61.187] => (item=['alice', 'c', '2']) => {\n    \"msg\": \"name is alice  vaule is c num is 2\"\n}\nok: [10.1.61.187] => (item=['alice', 'c', '3']) => {\n    \"msg\": \"name is alice  vaule is c num is 3\"\n}\nok: [10.1.61.187] => (item=['bob', 'a', '1']) => {\n    \"msg\": \"name is bob  vaule is a num is 1\"\n}\nok: [10.1.61.187] => (item=['bob', 'a', '2']) => {\n    \"msg\": \"name is bob  vaule is a num is 2\"\n}\nok: [10.1.61.187] => (item=['bob', 'a', '3']) => {\n    \"msg\": \"name is bob  vaule is a num is 3\"\n}\nok: [10.1.61.187] => (item=['bob', 'b', '1']) => {\n    \"msg\": \"name is bob  vaule is b num is 1\"\n}\nok: [10.1.61.187] => (item=['bob', 'b', '2']) => {\n    \"msg\": \"name is bob  vaule is b num is 2\"\n}\nok: [10.1.61.187] => (item=['bob', 'b', '3']) => {\n    \"msg\": \"name is bob  vaule is b num is 3\"\n}\nok: [10.1.61.187] => (item=['bob', 'c', '1']) => {\n    \"msg\": \"name is bob  vaule is c num is 1\"\n}\nok: [10.1.61.187] => (item=['bob', 'c', '2']) => {\n    \"msg\": \"name is bob  vaule is c num is 2\"\n}\nok: [10.1.61.187] => (item=['bob', 'c', '3']) => {\n    \"msg\": \"name is bob  vaule is c num is 3\"\n}\n\nPLAY RECAP *******************************************************************************************************\n10.1.61.187 \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br")])]),n("h3",{attrs:{id:"_4-3-with-dict"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-with-dict"}},[s._v("#")]),s._v(" 4.3 with_dict")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 假如有如下变量内容：")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("users")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("alice")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Alice Appleworth\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("telephone")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 123"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("456"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7890")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("bob")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Bob Bananarama\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("telephone")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 987"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("654"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3210")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 现在需要输出每个用户的用户名和手机号：")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tasks")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Print phone records\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("debug")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(' msg="User '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" item.key "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" is "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" item.value.name "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" ("),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" item.value.telephone "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(')"\n    '),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("with_dict")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ users }}"')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("h3",{attrs:{id:"_4-4-with-fileglob"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-with-fileglob"}},[s._v("#")]),s._v(" 4.4 with_fileglob")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: test\n  tasks:\n    - name: Make key directory     \n      file: \n        path: /root/.sshkeys \n        state: directory \n        mode: 0700 \n        owner: root \n        group: root \n        \n    - name: Upload public keys     \n      copy: \n        src: "{{ item }}"\n        dest: /root/.sshkeys\n        mode: 0600 \n        owner: root \n        group: root  \n      with_fileglob:\n        - /root/.ssh/*.pub \n        \n    - name: Assemble keys into authorized_keys file     \n      assemble: \n        src: /root/.sshkeys \n        dest: /root/.ssh/authorized_keys\n        mode: 0600 \n        owner: root \n        group: root\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("h3",{attrs:{id:"_4-5-with-lines"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-with-lines"}},[s._v("#")]),s._v(" 4.5 with_lines")]),s._v(" "),n("p",[s._v("with_lines循环结构会让你在控制主机上执行任意命令，并对命令的输出进行逐行迭代。假设我们有一个 文件test.txt包含如下行：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("Breeze Yan\nBernie Yang\njerry Qing\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("我们可以通过如下方法进行逐行输出：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- name: print all names\n  debug: msg="{{ item }}"\n  with_lines:\n    - cat test.txt\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h3",{attrs:{id:"_4-6-with-subelement"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-6-with-subelement"}},[s._v("#")]),s._v(" 4.6 with_subelement")]),s._v(" "),n("p",[s._v("假如现在需要遍历一个用户列表，并创建每个用户，而且还需要为每个用户配置以特定的SSH key登录。变量文件内容如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('users:\n  - name: alice\n    authorized:\n      - /tmp/alice/onekey.pub\n      - /tmp/alice/twokey.pub\n    mysql:\n        password: mysql-password\n        hosts:\n          - "%"\n          - "127.0.0.1"\n          - "::1"\n          - "localhost"\n        privs:\n          - "*.*:SELECT"\n          - "DB1.*:ALL"\n  - name: bob\n    authorized:\n      - /tmp/bob/id_rsa.pub\n    mysql:\n        password: other-mysql-password\n        hosts:\n          - "db1"\n        privs:\n          - "*.*:SELECT"\n          - "DB2.*:ALL"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br")])]),n("p",[s._v("playbook中定义如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("tasks:\n  - user: name={{ item.name }} state=present generate_ssh_key=yes\n    with_items: \"{{users}}\"\n  - authorized_key: \"user={{ item.0.name }} key='{{ lookup('file', item.1) }}'\"\n    with_subelements:\n     - users\n     - authorized\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("也可以遍历嵌套的子列表：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- name: Setup MySQL users\n  mysql_user: name={{ item.0.name }} password={{ item.0.mysql.password }} host={{ item.1 }} priv={{ item.0.mysql.privs | join('/') }}\n  with_subelements:\n    - users\n    - mysql.hosts\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"_4-7-with-sequence"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-7-with-sequence"}},[s._v("#")]),s._v(" 4.7 with_sequence")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- hosts: all\n  tasks:\n    # create groups\n    - group: name=evens state=present\n    - group: name=odds state=present\n    # create some test users\n    - user: name={{ item }} state=present groups=evens\n      with_sequence: start=0 end=32 format=testuser%02d\n    # create a series of directories with even numbers for some reason\n    - file: dest=/var/stuff/{{ item }} state=directory\n      with_sequence: start=4 end=16 stride=2    # stride用于指定步长\n    # a simpler way to use the sequence plugin\n    # create 4 groups\n    - group: name=group{{ item }} state=present\n      with_sequence: count=4\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("h3",{attrs:{id:"_4-8-with-random-choice"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-8-with-random-choice"}},[s._v("#")]),s._v(" 4.8 with_random_choice")]),s._v(" "),n("p",[s._v("从列表中随机取一个值：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- debug: msg={{ item }}\n  with_random_choice:\n     - "go through the door"\n     - "drink from the goblet"\n     - "press the red button"\n     - "do nothing"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h3",{attrs:{id:"_4-9-do-util循环"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-9-do-util循环"}},[s._v("#")]),s._v(" 4.9 do-Util循环")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- action: shell /usr/bin/foo\n  register: result\n  until: result.stdout.find("all systems go") != -1\n  retries: 5\n  delay: 10\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v('重复执行shell模块，当shell模块执行的命令输出内容包含"all systems go"的时候停止。重试5次，延迟时间10秒。retries默认值为3，delay默认值为5。任务的返回值为最后一次循环的返回结果。')]),s._v(" "),n("h3",{attrs:{id:"_4-10-with-together"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-10-with-together"}},[s._v("#")]),s._v(" 4.10 with_together")]),s._v(" "),n("p",[s._v("示例：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: webservers\n  remote_user: root\n  vars:\n    alpha: [ \'a\',\'b\',\'c\',\'d\']\n    numbers: [ 1,2,3,4 ]\n  tasks:\n    - debug: msg="{{ item.0 }} and {{ item.1 }}"\n      with_together:\n         - "{{ alpha }}"\n         - "{{ numbers }}"\n# 输出的结果为：\nok: [192.168.1.65] => (item=[\'a\', 1]) => {\n    "item": [\n        "a",\n        1\n    ],\n    "msg": "a and 1"\n}\nok: [192.168.1.65] => (item=[\'b\', 2]) => {\n    "item": [\n        "b",\n        2\n    ],\n    "msg": "b and 2"\n}\nok: [192.168.1.65] => (item=[\'c\', 3]) => {\n    "item": [\n        "c",\n        3\n    ],\n    "msg": "c and 3"\n}\nok: [192.168.1.65] => (item=[\'d\', 4]) => {\n    "item": [\n        "d",\n        4\n    ],\n    "msg": "d and 4"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br")])]),n("blockquote",[n("p",[s._v("参考链接：")]),s._v(" "),n("p",[s._v("https://www.cnblogs.com/breezey/p/10996629.html")]),s._v(" "),n("p",[s._v("https://blog.51cto.com/cloumn/blog/1544")])])])}),[],!1,null,null,null);a.default=t.exports},659:function(s,a,n){"use strict";n.r(a);var e=n(1),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"_1-简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[s._v("#")]),s._v(" 1 简介")]),s._v(" "),n("p",[s._v("在有的时候play的结果依赖于变量、fact或者是前一个任务的执行结果，或者有的时候，我们会基于上一个task执行返回的结果而决定如何执行后续的task。这个时候就需要用到条件判断。")]),s._v(" "),n("p",[s._v("条件语句在Ansible中的使用场景：")]),s._v(" "),n("ul",[n("li",[s._v("在目标主机上定义了一个硬限制，比如目标主机的最小内存必须达到多少，才能执行该task")]),s._v(" "),n("li",[s._v("捕获一个命令的输出，根据命令输出结果的不同以触发不同的task")]),s._v(" "),n("li",[s._v("根据不同目标主机的facts，以定义不同的task")]),s._v(" "),n("li",[s._v("根据目标机的cpu的大小，以调优相关应用性能")]),s._v(" "),n("li",[s._v("用于判断某个服务的配置文件是否发生变更，以确定是否需要重启服务")])]),s._v(" "),n("h2",{attrs:{id:"_2-when关键字"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-when关键字"}},[s._v("#")]),s._v(" 2 when关键字")]),s._v(" "),n("h3",{attrs:{id:"_2-1-when基本使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-when基本使用"}},[s._v("#")]),s._v(" 2.1 when基本使用")]),s._v(" "),n("p",[s._v("在ansible中，使用条件判断的关键字就是when。")]),s._v(" "),n("p",[s._v("如在安装包的时候，需要指定主机的操作系统类型，或者是当操作系统的硬盘满了之后，需要清空文件等,可以使用when语句来做判断 。when关键字后面跟着的是python的表达式,在表达式中你能够使用任何的变量或者fact,当表达式的结果返回的是false,便会跳过本次的任务")]),s._v(" "),n("p",[s._v("下面是一个基本的用法示例：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('---\n- name: Install vim\n  hosts: all\n  tasks:\n    - name:Install VIM via yum\n      yum: \n        name: vim-enhanced \n        state: installed\n      when: ansible_os_family =="RedHat"\n      \n    - name:Install VIM via apt\n      apt: \n        name: vim \n        state: installed\n      when: ansible_os_family =="Debian"\n      \n    - name: Unexpected OS family\n      debug: msg="OS Family {{ ansible_os_family }} is not supported" fail=yes\n      when: not ansible_os_family =="RedHat" or ansible_os_family =="Debian"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("h3",{attrs:{id:"_2-2-比较运算符"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-比较运算符"}},[s._v("#")]),s._v(" 2.2  比较运算符")]),s._v(" "),n("p",[s._v('在上面的示例当中，我们使用了"=="的比较运算符，在ansible中，还支持如下比较运算符：')]),s._v(" "),n("ul",[n("li",[n("code",[s._v("==")]),s._v("：比较两个对象是否相等，相等则返回真。可用于比较字符串和数字")]),s._v(" "),n("li",[n("code",[s._v("!=")]),s._v("：比较两个对象是否不等，不等则为真。")]),s._v(" "),n("li",[n("code",[s._v(">")]),s._v("：比较两个对象的大小，左边的值大于右边的值，则为真")]),s._v(" "),n("li",[n("code",[s._v("<")]),s._v("：比较两个对象的大小，左边的值小于右边的值，则为真")]),s._v(" "),n("li",[n("code",[s._v(">=")]),s._v("：比较两个对象的大小，左边的值大于等于右边的值，则为真")]),s._v(" "),n("li",[n("code",[s._v("<=")]),s._v("：比较两个对象的大小，左边的值小于等于右边的值，则为真")])]),s._v(" "),n("p",[s._v("下面是一些简单的示例：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('when: ansible_machine == "x86_64" \n\nwhen: max_memory <= 512\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h3",{attrs:{id:"_2-3-逻辑运算符"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-逻辑运算符"}},[s._v("#")]),s._v(" 2.3 逻辑运算符")]),s._v(" "),n("p",[s._v("在Ansible中，除了比较运算符，还支持逻辑运算符：")]),s._v(" "),n("ul",[n("li",[s._v("and：逻辑与，当左边和右边两个表达式同时为真，则返回真")]),s._v(" "),n("li",[s._v("or：逻辑或，当左右和右边两个表达式任意一个为真，则返回真")]),s._v(" "),n("li",[s._v("not：逻辑否，对表达式取反")]),s._v(" "),n("li",[s._v("()：当一组表达式组合在一起，形成一个更大的表达式，组合内的所有表达式都是逻辑与的关系")])]),s._v(" "),n("p",[s._v("示例：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# 逻辑或\nwhen: ansible_distribution == "RedHat" or ansible_distribution == "Fedora"\n\n# 逻辑与\nwhen: ansible_distribution_version == "7.5" and ansible_kernel == "3.10.0-327.el7.x86_64"\n\nwhen:\n  - ansible_distribution_version == "7.5"\n  - ansible_kernel == "3.10.0-327.el7.x86_64"\n  \n# 组合\n\nwhen: => \n  ( ansible_distribution == "RedHat" and ansible_distribution_major_version == "7" )\n  or\n  ( ansible_distribution == "Fedora" and ansible_distribution_major_version == "28")\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("一个完整的例子：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 判断register注册变量的返回结果\n- name: restart httpd if postfix is running\n  hosts: test\n  tasks:\n    - name: get postfix server status\n      command: /usr/bin/systemctl is-active postfix\n      ignore_errors: yes\n      register: result\n      \n    - name: restart apache httpd based on postfix status\n      service:\n        name: httpd\n        state: restarted\n      when: result.rc == 0\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("h2",{attrs:{id:"_3-条件判断与tests"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-条件判断与tests"}},[s._v("#")]),s._v(" 3 条件判断与tests")]),s._v(" "),n("p",[s._v("在shell当中，我们可使用test命令来进行一些常用的判断操作，如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 判断/test文件是否存在\ntest -e /test\n\n# 判断/testdir是否存在且为一个目录\ntest -d /testdir\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("事实上，在ansible中也有类似的用法，只不过ansible没有使用linux的test命令，而是jinja2模板的tests。")]),s._v(" "),n("p",[s._v("下面是一个简单示例：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# 通过条件语句判断testpath的路径是否存在\n- hosts: test\n  vars:\n    testpath: /testdir\n  tasks:\n    - debug:\n        msg: "file exist"\n      when: testpath is exists\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("上面的示例中，我们使用了"),n("code",[s._v("is exists")]),s._v("用于路径存在时返回真，也可以使用"),n("code",[s._v("is not exists")]),s._v("用于路径不存在时返回真。也可以在整个条件表达式的前面使用not以取反：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: test\n  vars:\n    testpath: /testdir1\n  tasks:\n    - debug:\n        msg: "file not exist"\n      when: not testpath is exists\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("在ansible中，除了能够使用exists这种tests之外，还有一些别的tests。接下来我们详细说一说。")]),s._v(" "),n("h3",{attrs:{id:"_3-1-判断变量"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-判断变量"}},[s._v("#")]),s._v(" 3.1 判断变量")]),s._v(" "),n("ul",[n("li",[s._v("defined：判断变量是否已定义，已定义则返回真")]),s._v(" "),n("li",[s._v("undefined：判断变量是否未定义，未定义则返回真")]),s._v(" "),n("li",[s._v("none：判断变量的值是否为空，如果变量已定义且值为空，则返回真")])]),s._v(" "),n("p",[s._v("示例：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: test\n  gather_facts: no\n  vars:\n    testvar: "test"\n    testvar1:\n  tasks:\n    - debug:\n        msg: "testvar is defined"\n      when: testvar is defined\n    - debug:\n        msg: "testvar2 is undefined"\n      when: testvar2 is undefined\n    - debug:\n        msg: "testvar1 is none"\n      when: testvar1 is none\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("h3",{attrs:{id:"_3-2-判断执行结果"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-判断执行结果"}},[s._v("#")]),s._v(" 3.2 判断执行结果")]),s._v(" "),n("ul",[n("li",[s._v("sucess或succeeded：通过任务执行结果返回的信息判断任务的执行状态，任务执行成功则返回true")]),s._v(" "),n("li",[s._v("failure或failed：任务执行失败则返回true")]),s._v(" "),n("li",[s._v("change或changed：任务执行状态为changed则返回true")]),s._v(" "),n("li",[s._v("skip或skipped：任务被跳过则返回true")])]),s._v(" "),n("p",[s._v("示例：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: test\n  gather_facts: no\n  vars:\n    doshell: true\n  tasks:\n    - shell: \'cat /testdir/aaa\'\n      when: doshell\n      register: result\n      ignore_errors: true\n    - debug:\n        msg: "success"\n      when: result is success\n      \n    - debug:\n        msg: "failed"\n      when: result is failure\n      \n    - debug:\n        msg: "changed"\n      when: result is change\n      \n    - debug:\n        msg: "skip"\n      when: result is skip\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("h3",{attrs:{id:"_3-3-判断路径"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-判断路径"}},[s._v("#")]),s._v(" 3.3 判断路径")]),s._v(" "),n("ul",[n("li",[s._v("file：判断指定路径是否为一个文件，是则为真")]),s._v(" "),n("li",[s._v("directory：判断指定路径是否为一个目录，是则为真")]),s._v(" "),n("li",[s._v("link：判断指定路径是否为一个软链接，是则为真")]),s._v(" "),n("li",[s._v("mount：判断指定路径是否为一个挂载点，是则为真")]),s._v(" "),n("li",[s._v("exists：判断指定路径是否存在，存在则为真")])]),s._v(" "),n("blockquote",[n("p",[s._v("特别注意：关于路径的所有判断均是判断主控端上的路径，而非被控端上的路径")])]),s._v(" "),n("p",[s._v("示例：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: test\n  gather_facts: no\n  vars:\n    testpath1: "/testdir/test"\n    testpath2: "/testdir"\n  tasks:\n    - debug:\n        msg: "file"\n      when: testpath1 is file\n    - debug:\n        msg: "directory"\n      when: testpath2 is directory\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("h3",{attrs:{id:"_3-4-判断字符串"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-判断字符串"}},[s._v("#")]),s._v(" 3.4 判断字符串")]),s._v(" "),n("ul",[n("li",[s._v("lower：判断字符串中的所有字母是否都是小写，是则为真")]),s._v(" "),n("li",[s._v("upper：判断字符串中的所有字母是否都是大写，是则为真")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: test\n  gather_facts: no\n  vars: \n    str1: "abc"\n    str2: "ABC"\n  tasks:\n    - debug:\n        msg: "str1 is all lowercase"\n      when: str1 is lower\n    - debug:\n        msg: "str2 is all uppercase"\n      when: str2 is upper\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("h3",{attrs:{id:"_3-5-判断整除"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-判断整除"}},[s._v("#")]),s._v(" 3.5 判断整除")]),s._v(" "),n("ul",[n("li",[s._v("even：判断数值是否为偶数，是则为真")]),s._v(" "),n("li",[s._v("odd：判断数值是否为奇数，是则为真")]),s._v(" "),n("li",[s._v("divisibleby(num)：判断是否可以整除指定的数值，是则为真")])]),s._v(" "),n("p",[s._v("示例：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: test\n  gather_facts: no\n  vars: \n    num1: 6\n    num2: 8 \n    num3: 15\n  tasks:\n    - debug: \n        msg: "num1 is an even number"\n      when: num1 is even\n    - debug:\n        msg: "num2 is an odd number"\n      when: num2 is odd\n    - debug:\n        msg: "num3 can be divided exactly by"\n      when: num3 is divisibleby(3)\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("h3",{attrs:{id:"_3-6-其他tests"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-其他tests"}},[s._v("#")]),s._v(" 3.6 其他tests")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("version")]),s._v(" "),n("p",[s._v('可用于对比两个版本号的大小，或者与指定的版本号进行对比，使用语法为version("版本号","比较操作符")')]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: test\n  vars:\n    ver1: 1.2\n    ver2: 1.3\n  tasks:\n    - debug:\n        msg: "ver1 is greater than ver2"\n      when: ver1 is version(ver2,">")\n    - debug:\n        msg: "system version {{ ansible_distribution_version }} greater than 7.3"\n      when: ansible_distribution_version is version("7.3","gt")\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("version中使用的比较运算符说明：")]),s._v(" "),n("ul",[n("li",[s._v("大于： >, gt")]),s._v(" "),n("li",[s._v("大于等于： >=, ge")]),s._v(" "),n("li",[s._v("小于： <, lt")]),s._v(" "),n("li",[s._v("小于等于： <=, le")]),s._v(" "),n("li",[s._v("等于： =, ==, eq")]),s._v(" "),n("li",[s._v("不等于： !=, <>, ne")])])]),s._v(" "),n("li",[n("p",[s._v("subset\n判断一个list是不是另一个list的子集")])]),s._v(" "),n("li",[n("p",[s._v('superset\n判断一个list是不是另一个list的父集"')]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: test\n  gather_facts: no\n  vars:\n    a:\n      - 2\n      - 5\n    b: [1,2,3,4,5]\n  tasks:\n    - debug:\n        msg: "A is a subset of B"\n      when: a is subset(b)\n    - debug:\n        msg: "B is the parent set of A"\n      when: b is superset(a)\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("in\n判断一个字符串是否存在于另一个字符串中，也可用于判断某个特定的值是否存在于列表中")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: test\n  vars:\n    supported_distros:\n      - RedHat\n      - CentOS\n  tasks:\n    - debug:\n        msg: "{{ ansible_distribution }} in supported_distros"\n      when: ansible_distribution in supported_distros\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("string\n判断对象是否为一个字符串，是则为真")])]),s._v(" "),n("li",[n("p",[s._v("number\n判断对象是否为一个数字，是则为真")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: test\n  gather_facts: no\n  vars:\n    var1: 1\n    var2: "1"\n    var3: a\n  tasks:\n    - debug:\n        msg: "var1 is a number"\n      when: var1 is number\n    - debug:\n        msg: "var2 is a string"\n      when: var2 is string\n    - debug:\n        msg: "var3 is a string"\n      when: var3 is string\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("h2",{attrs:{id:"_4-条件判断与block"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-条件判断与block"}},[s._v("#")]),s._v(" 4 条件判断与block")]),s._v(" "),n("h3",{attrs:{id:"_4-1-block"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-block"}},[s._v("#")]),s._v(" 4.1 block")]),s._v(" "),n("p",[s._v("我们在前面使用when做条件判断时，如果条件成立则执行对应的任务。但这就面临一个问题，当我们要使用同一个条件判断执行多个任务的时候，就意味着我们要在某一个任务下面都写一下when语句，而且判断条件完全一样。这种方式不仅麻烦而且显得low。Ansible提供了一种更好的方式来解决这个问题，即block。")]),s._v(" "),n("p",[s._v("在ansible中，使用block将多个任务进行组合，当作一个整体。我们可以对这一个整体做条件判断，当条件成立时，则执行块中的所有任务：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: test\n  tasks:\n    - debug:\n        msg: "task1 not in block"\n    - block:\n        - debug:\n            msg: "task2 in block1"\n        - debug:\n            msg: "task3 in block1"\n      when: 2 > 1\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("下面是一个稍微有用点儿的例子：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- hosts: test\n  tasks:\n    - name: set /etc/resolv.conf\n      template: \n        src: resolv.conf.j2 \n        dest: /etc/resolv.conf \n        owner: root \n        group: root \n        mode: 0644\n    - block:\n        - name: ensure /etc/resolvconf/resolv.conf.d/base file for ubuntu 16.04\n          template: \n            src: resolv.conf.j2\n            dest: /etc/resolvconf/resolv.conf.d/base\n       \n        - name: config dns for ubuntu 16.04\n          template: \n            src: resolv.conf.j2\n            dest: /etc/resolv.conf\n      when: ansible_distribution == "Ubuntu" and ansible_distribution_major_version == "16" \n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("p",[s._v("使用block注意事项：")]),s._v(" "),n("ol",[n("li",[s._v("可以为block定义name（ansible 2.3增加的特性）")]),s._v(" "),n("li",[s._v("可以直接对block使用when，但不能直接对block使用loop")])]),s._v(" "),n("h3",{attrs:{id:"_4-2-rescue"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-rescue"}},[s._v("#")]),s._v(" 4.2 rescue")]),s._v(" "),n("p",[s._v("block除了能和when一起使用之外，还能作错误处理。这个时候就需要用到rescue关键字：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- hosts: test\n  tasks:\n    - block:\n        - shell: 'ls /testdir'\n      rescue:\n        - debug:\n            msg: '/testdir is not exists'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("在上面的例子中，当block中的任务执行失败时，则运行rescue中的任务。如果block中的任务正常执行，则rescue的任务就不会被执行。如果block中有多个任务，则任何一个任务执行失败，都会执行rescue。block中可以定义多个任务，同样rescue当中也可以定义多个任务。")]),s._v(" "),n("h3",{attrs:{id:"_4-3-always"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-always"}},[s._v("#")]),s._v(" 4.3 always")]),s._v(" "),n("p",[s._v("当block执行失败时，rescue中的任务才会被执行；而无论block执行成功还是失败，always中的任务都会被执行：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- hosts: test\n  tasks:\n    - block:\n        - shell: 'ls /testdir'\n      rescue:\n        - debug:\n            msg: '/testdir is not exists'\n      always:\n        - debug:\n            msg: 'This task always executes'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("h2",{attrs:{id:"_5-条件判断与错误处理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-条件判断与错误处理"}},[s._v("#")]),s._v(" 5 条件判断与错误处理")]),s._v(" "),n("p",[s._v("在上面讲block的使用方法的时候，我们说block除了可以将多个任务组合到一起，还有错误处理的功能。接下来我们继续说一说错误处理。")]),s._v(" "),n("h3",{attrs:{id:"_5-1-fail模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-fail模块"}},[s._v("#")]),s._v(" 5.1 fail模块")]),s._v(" "),n("p",[s._v('在shell中，可能会有这样的需求：当脚本执行至某个阶段时，需要对某个条件进行判断，如果条件成立，则立即终止脚本的运行。在shell中，可以直接调用"exit"即可执行退出。事实上，在playbook中也有类似的模块可以做这件事。即fail模块。')]),s._v(" "),n("p",[s._v("fail模块用于终止当前playbook的执行，通常与条件语句组合使用，当满足条件时，终止当前play的运行。")]),s._v(" "),n("p",[s._v("选项只有一个：")]),s._v(" "),n("ul",[n("li",[s._v("msg：终止前打印出信息")])]),s._v(" "),n("p",[s._v("示例：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用fail模块中断playbook输出")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tasks")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("shell")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(' echo "Just a test'),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('error" \n      '),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("register")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" result\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("fail")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("msg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Conditions established,Interrupt running playbook"')]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("when")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"'error' in result.stdout\"")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("debug")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("msg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Inever execute,Because the playbook has stopped"')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("h3",{attrs:{id:"_5-2-failed-when"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-failed-when"}},[s._v("#")]),s._v(" 5.2 failed_when")]),s._v(" "),n("p",[s._v("事实上，当fail和when组合使用的时候，还有一个更简单的写法，即"),n("code",[s._v("failed_when")]),s._v("，当满足某个条件时，ansible主动触发失败。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 如果在command_result存在错误输出，且错误输出中，包含了`FAILED`字串，即返回失败状态：\n- name: this command prints FAILED when it fails\n  command: /usr/bin/example-command -x -y -z\n  register: command_result\n  failed_when: \"'FAILED' in command_result.stderr\"\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("也可以直接通过"),n("code",[s._v("fail")]),s._v("模块和"),n("code",[s._v("when")]),s._v("条件语句，写成如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- name: this command prints FAILED when it fails\n  command: /usr/bin/example-command -x -y -z\n  register: command_result\n  ignore_errors: True\n\n- name: fail the play if the previous command did not succeed\n  fail: msg="the command failed"\n  when: " command_result.stderr and \'FAILED\' in command_result.stderr"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("blockquote",[n("p",[s._v("ansible一旦执行返回失败，后续操作就会中止，所以failed_when通常可以用于满足某种条件时主动中止playbook运行的一种方式。")])]),s._v(" "),n("blockquote",[n("p",[s._v("ansible默认处理错误的机制是遇到错误就停止执行。但有些时候，有些错误是计划之中的。我们希望忽略这些错误，以让playbook继续往下执行。这个时候就可以使用"),n("code",[s._v("ignore_errors")]),s._v("忽略错误，从而让playbook继续往下执行。")])]),s._v(" "),n("h3",{attrs:{id:"_5-3-changed-when"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-changed-when"}},[s._v("#")]),s._v(" 5.3 changed_when")]),s._v(" "),n("p",[s._v("当我们控制一些远程主机执行某些任务时，当任务在远程主机上成功执行，状态发生更改时，会返回changed状态响应，状态未发生更改时，会返回OK状态响应，当任务被跳过时，会返回skipped状态响应。我们可以通过"),n("code",[s._v("changed_when")]),s._v("来手动更改"),n("code",[s._v("changed")]),s._v("响应状态。示例如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- shell: /usr/bin/billybass --mode=\"take me to the river\"\nregister: bass_result\nchanged_when: \"bass_result.rc != 2\"    #只有该条task执行以后，bass_result.rc的值不为2时，才会返回changed状态\n\n# this will never report 'changed' status\n- shell: wall 'beep'\n  changed_when: False    #当changed_when为false时，该条task在执行以后，永远不会返回changed状态\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h3",{attrs:{id:"_5-4-断言-assert模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-断言-assert模块"}},[s._v("#")]),s._v(" 5.4 断言：assert模块")]),s._v(" "),n("p",[s._v("对于当满足某某条件时就失败的逻辑，可以使用fail模块加when指令来实现，也可使用更为直接的assert模块进行断言。")]),s._v(" "),n("p",[s._v("例如：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('---\n- hosts: localhost\n  gather_facts: no\n  tasks:\n    - assert:\n        that:\n          - 100 > 20\n          - 200 > 200\n      fail_msg: "oh, not me"\n      success_msg: "oh, it\'s me"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("其中that参数接收一个列表，用于定义一个或多个条件，如果条件全为true，则任务成功，只要有一个条件为false，则任务失败。fail_msg(或其别名参数msg)定义任务失败时的信息，success_msg定义任务成功时的信息。")]),s._v(" "),n("h3",{attrs:{id:"_5-5-any-errors-fatal"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-5-any-errors-fatal"}},[s._v("#")]),s._v(" 5.5 any_errors_fatal")]),s._v(" "),n("p",[s._v("如果想让某个失败的任务直接导致整个play的失败，可在play级别使用any_errors_fatal指令。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('---\n- hosts: nginx\n  gather_facts: no\n  any_errors_fatal: true\n  tasks:\n    - fail:\n        msg: "oh, not me"\n      when: inventory_hostname == groups[\'nginx\'][0]\n    - debug:\n        msg: "hello"\n\n- hosts: localhost\n  gather_facts: no\n  tasks:\n    - debug:\n        msg: "HELLO WORLD"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("将any_errors_fatal设置为true后，nginx组第一个节点只要一开始执行fail任务，整个playbook中所有后续任务都将不再执行，就连其它play也一样不执行。")]),s._v(" "),n("p",[s._v('注意观察playbook的执行结果，它将提示"NO MORE HOSTS LEFT"：')]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('........\nTASK [fail] *********************\nfatal: [192.168.200.42]: FAILED! => {"changed": false, "msg": "oh, not me"}\nskipping: [192.168.200.43]\nskipping: [192.168.200.44]\n\nNO MORE HOSTS LEFT **************\n\nPLAY RECAP *************\n.........\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("h3",{attrs:{id:"_5-6-max-fail-percentage"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-max-fail-percentage"}},[s._v("#")]),s._v(" 5.6 max_fail_percentage")]),s._v(" "),n("p",[s._v("略")]),s._v(" "),n("h2",{attrs:{id:"_6-在循环语句中使用条件语句"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-在循环语句中使用条件语句"}},[s._v("#")]),s._v(" 6 在循环语句中使用条件语句")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# 只打印大于5的值\ntasks:\n    - command: echo {{ item }}\n      loop: [ 0, 2, 4, 6, 8, 10 ]\n      when: item > 5\n# 确保将mariadb-server安装到根分区且根分区的可用空间要大于300M\n- name: install mariadb-server if enough space on root\n  yum: \n    name: mariadb-server\n    state；拉特st\n  loop: "{{ ansible_mounts }}"\n  when: item.mount == "/" and item.size_available > 300000000\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("blockquote",[n("p",[s._v("转载链接：https://www.cnblogs.com/breezey/p/10996632.html")])])])}),[],!1,null,null,null);a.default=t.exports},661:function(s,a,n){"use strict";n.r(a);var e=n(1),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"_1-简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[s._v("#")]),s._v(" 1 简介")]),s._v(" "),n("p",[s._v("在大型项目当中，通常一个playbook会有非常多的task。而我们每次执行这个playbook时，都会将所有task运行一遍。而事实上，在实际使用过程中，我们可能只是想要执行其中的一部分任务而已，并不想把整个playbook完整跑一遍。这个时候就需要用到tags。")]),s._v(" "),n("p",[s._v("通过tags，我们可以给playbook中的某一些任务打上“标签”，而在执行playbook的时候，我们可以通过选定标签的方式指定只执行哪一些任务或者不执行哪一些任务。")]),s._v(" "),n("h2",{attrs:{id:"_2-为task打tag"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-为task打tag"}},[s._v("#")]),s._v(" 2 为task打tag")]),s._v(" "),n("p",[s._v("下面是一个安装httpd的简单示例：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/ansible/playbook/install_web.yml")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" configure webservers \n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" all\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("remote_user")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ansible\n  \n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tasks")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Install httpd\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("yum")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" httpd\n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("state")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" present\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install_httpd\n        \n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Cofiguration httpd\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("copy")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("src")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /root/httpd.conf \n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/httpd/conf/httpd.conf\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" conf_httpd   \n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("notify")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" restart httpd\n        \n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Start httpd\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" httpd \n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("state")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" started \n        "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enabled")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" no\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" start_httpd\n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("handlers")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" restart httpd\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name=httpd state=restart\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br")])]),n("p",[s._v("在上面的示例中，我们为两个task定义了三个tags："),n("code",[s._v("install_httpd")]),s._v("、"),n("code",[s._v("conf_httpd")]),s._v("以及"),n("code",[s._v("start_httpd")]),s._v("。")]),s._v(" "),n("h2",{attrs:{id:"_3-使用tag"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-使用tag"}},[s._v("#")]),s._v(" 3 使用tag")]),s._v(" "),n("h3",{attrs:{id:"_3-1-执行指定tag的task"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-执行指定tag的task"}},[s._v("#")]),s._v(" 3.1 执行指定tag的task")]),s._v(" "),n("p",[s._v("有了tags之后，我们就可以只运行playbook中指定标签的task了：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# ansible-playbook  install_web.yml --tags "start_httpd"\n\nPLAY [configure webservers] *************************************************************************************************************************************************\n\nTASK [Gathering Facts] ******************************************************************************************************************************************************\nok: [10.1.61.187]\n\nTASK [Start httpd] **********************************************************************************************************************************************************\nchanged: [10.1.61.187]\n\nPLAY RECAP ******************************************************************************************************************************************************************\n10.1.61.187                : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  \n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("也可以一次指定多个tag执行：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# ansible-playbook install_web.yml     --tags "conf_httpd,start_httpd"\n\nPLAY [configure webservers] *************************************************************************************************************************************************\n\nTASK [Gathering Facts] ******************************************************************************************************************************************************\nok: [10.1.61.187]\n\nTASK [Cofiguration httpd] ***************************************************************************************************************************************************\nok: [10.1.61.187]\n\nTASK [Start httpd] **********************************************************************************************************************************************************\nok: [10.1.61.187]\n\nPLAY RECAP ******************************************************************************************************************************************************************\n10.1.61.187                : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 \n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("h3",{attrs:{id:"_3-2-排除指定tag的task"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-排除指定tag的task"}},[s._v("#")]),s._v(" 3.2 排除指定tag的task")]),s._v(" "),n("p",[s._v("通过下面的方式可以排除指定了tag的task，即除了指定tag的task不执行，其他task都执行：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# ansible-playbook --skip-tags="install_httpd" install_web.yml                           \n\nPLAY [configure webservers] *************************************************************************************************************************************************\n\nTASK [Gathering Facts] ******************************************************************************************************************************************************\nok: [10.1.61.187]\n\nTASK [Cofiguration httpd] ***************************************************************************************************************************************************\nok: [10.1.61.187]\n\nTASK [Start httpd] **********************************************************************************************************************************************************\nok: [10.1.61.187]\n\nPLAY RECAP ******************************************************************************************************************************************************************\n10.1.61.187                : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 \n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("执行效果跟上面一样。")]),s._v(" "),n("h3",{attrs:{id:"_3-3-查看playbook中的所有tag"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-查看playbook中的所有tag"}},[s._v("#")]),s._v(" 3.3 查看playbook中的所有tag")]),s._v(" "),n("p",[s._v("可以通过"),n("code",[s._v("--list-tags")]),s._v("参数列出指定的playbook中所有的tag")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# ansible-playbook --list-tags install_web.yml                          \n\nplaybook: install_web.yml\n\n  play #1 (all): configure webservers   TAGS: []\n      TASK TAGS: [conf_httpd, install_httpd, start_httpd]\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h2",{attrs:{id:"_4-打tag的几种方式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-打tag的几种方式"}},[s._v("#")]),s._v(" 4 打tag的几种方式")]),s._v(" "),n("ol",[n("li",[s._v("为一个任务指定一个标签")])]),s._v(" "),n("p",[s._v("这种方式就是上面示例中的方法：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" conf_httpd\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ol",[n("li",[s._v("为一个任务指定多个标签")])]),s._v(" "),n("p",[s._v("可以通过列表的方式为一个任务指定多个标签：")]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" install_httpd\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" install_web\n  \n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'install_httpd'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'install_web'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tags")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install_httpd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("install_web\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("ol",[n("li",[s._v("为一个play指定一组标签")])]),s._v(" "),n("p",[s._v("当为一个play指定一组标签后，该play下的所有task都会自动继承该标签，各task也可以自定义自己的标签。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("- name: configure webservers \n  hosts: all\n  remote_user: ansible\n  tags: \n    - httpd\n  tasks:\n    ...\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("在静态加载文件的指令上打标签，等价于为所加载文件中所有子任务打标签。")]),s._v(" "),n("p",[s._v("在动态加载文件的指令上打标签，不会为子任务打标签，而是为父任务自身打标签。")]),s._v(" "),n("p",[s._v("现在说结论：")]),s._v(" "),n("p",[s._v("(1).静态加载的指令有：roles、include、import_tasks、import_role")]),s._v(" "),n("p",[s._v("(2).动态加载的指令只有include_xxx，包括include_tasks、include_role")]),s._v(" "),n("p",[s._v("import_playbook和include_playbook因为本身就是play级别或高于play级别，所以不能为这两个指令打标签。")]),s._v(" "),n("h2",{attrs:{id:"_5-ansible内置tag"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-ansible内置tag"}},[s._v("#")]),s._v(" 5 ansible内置tag")]),s._v(" "),n("p",[s._v("除了用户自定义tag，ansible也内置了几个tag，这些tag都包含特殊含义：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v('always：一旦某个task被打上了always的tag，则无论是playbook的完整执行，还是指定tag执行，不管你指定的tag是啥，该任务总是会被执行。除非明确指定"--skip-tags=always"选项，才不会执行该task。')])]),s._v(" "),n("li",[n("p",[s._v('never：该标签与always正好相反，总是不会执行，除非明确指定"--tags=never"选项。')])]),s._v(" "),n("li",[n("p",[s._v("tagged：在调用时使用")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有打了tag的任务都会被执行，包含never tag的除外，没有标签的不会被执行")]),s._v("\nansible-playbook --tags tagged install_web.yaml \n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有打了tag的任务都不会被执行，包括always tag也不会被执行")]),s._v("\nansible-playbook --skip-tags tagged install_web.yaml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("untagged：在调用时使用")]),s._v(" "),n("div",{staticClass:"language-sh line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sh"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有未打tag的任务都会被执行，打了always tag的也会被执行")]),s._v("\nansibl-playbook --tags untagged install_web.yaml\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有未打tag的任务都不会被执行")]),s._v("\nansibl-playbook --skip-tags untagged install_web.yaml\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("all：表示所有任务都会被执行，在默认情况下，不指定任何标签，则使用的就是该标签")])])])])}),[],!1,null,null,null);a.default=t.exports},669:function(s,a,n){"use strict";n.r(a);var e=n(1),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"_1-简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[s._v("#")]),s._v(" 1 简介")]),s._v(" "),n("p",[s._v("在使用ansible的过程中，不可避免的会存储一些敏感信息，比如在变量文件中存储帐号密码信息等。")]),s._v(" "),n("p",[s._v("ansible通过ansible-vault命令行工具来提供对敏感文件的加密和解密。")]),s._v(" "),n("p",[s._v("ansible-vault可以创建、加密、解密和查看文件。其可以加密任何ansible使用的文件，包括inventory文件，playbook中调用的变量文件等。")]),s._v(" "),n("h2",{attrs:{id:"_2-ansible-vault常用操作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-ansible-vault常用操作"}},[s._v("#")]),s._v(" 2 Ansible-vault常用操作")]),s._v(" "),n("ol",[n("li",[s._v("创建加密文件")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ansible-vault create file\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ol",{attrs:{start:"2"}},[n("li",[s._v("编辑加密文件")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ansible-vault edit file\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ol",{attrs:{start:"3"}},[n("li",[s._v("重置密码")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ansible-vault rekey file\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ol",{attrs:{start:"4"}},[n("li",[s._v("加密已有文件")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ansible-vault encrypt file\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ol",{attrs:{start:"5"}},[n("li",[s._v("解密文件")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ansible-vault decrypt file\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ol",{attrs:{start:"6"}},[n("li",[s._v("查看文件")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ansible-vault view file\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h2",{attrs:{id:"_3-ansible-vault配置示例"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-ansible-vault配置示例"}},[s._v("#")]),s._v(" 3 Ansible-vault配置示例")]),s._v(" "),n("ol",[n("li",[s._v("创建一个user.yml的变量文件，内容如下:")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('username: "user1"\npwhash: "$1$GkTPu7we$ZZtdsLPIHkS.fmoVcn3v51"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ol",{attrs:{start:"2"}},[n("li",[s._v("加密上面创建的变量文件：")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# ansible-vault encrypt user.yml \nNew Vault password: \nConfirm New Vault password: \nEncryption successful\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("ol",{attrs:{start:"3"}},[n("li",[s._v("编写playbook文件如下：")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('- name: create user accounts for all our servers\n  hosts: test\n  become: True\n  remote_user: ansible\n  vars_files:\n    - user.yml\n  tasks:\n    - name: Creating user from user.yml\n      user:\n        name: "{{ username }}"\n        password: "{{ pwhash }}"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("ol",{attrs:{start:"4"}},[n("li",[s._v("执行playbook")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# ansible-playbook create_user.yml --ask-vault-pass\nVault password: \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("也可以通过如下操作执行playbook：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("echo redhat > vault-pass\nchmod 600 vault-pass\n\nansible-playbook create_user.yml --vault-password-file=vault-pass\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);