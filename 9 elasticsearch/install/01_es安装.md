## ansible配置

```bash
# 修改主机名
hostnamectl set-hostname elk_ans
# 生产密钥对，生成后将公钥导入到私有云主机中，创建新主机时使用
ssh-keygen 
```

```bash
# yum 安装
yum -y install ansible
# 修改主机列表为yaml格式
mv /etc/ansible/hosts{,.yml}
# 优化配置
egrep -v "^$|^#" /etc/ansible/ansible.cfg
```

```
[defaults]
inventory      = /etc/ansible/hosts.yml
roles_path    = /etc/ansible/roles
host_key_checking = False
deprecation_warnings = False
retry_files_enabled = False
[ssh_connection]
ssh_args = -C -o ControlMaster=auto -o ControlPersist=5d
```

## 安装Elasticsearch

```bash
# 下载roles
ansible-galaxy install elastic.elasticsearch,7.7.1
# 编写ansible主机清单
cat /etc/ansible/hosts.yml 
```

```
all:
  children:
    elasticsearch:
      children:
        es_master:
        es_data:
        es_ingest:
    es_master:
      hosts:
        es_master1:
          ansible_ssh_host: 172.16.91.227
        es_master2:
          ansible_ssh_host: 172.16.91.66
        es_master3:
          ansible_ssh_host: 172.16.91.73
    es_data:
      hosts:
        es_data1:
          ansible_ssh_host: 172.16.91.119
        es_data2:
          ansible_ssh_host: 172.16.91.85
        es_data3:
          ansible_ssh_host: 172.16.91.229
    es_ingest:
      hosts:
        es_ingest1:
          ansible_ssh_host: 172.16.91.27
        es_ingest2:
          ansible_ssh_host: 172.16.91.1
        es_ingest3:
          ansible_ssh_host: 172.16.91.151
```

```bash
# 编写playbook
cat /etc/ansible/playbook/es.yml 
```

```bash
---
# 注意修改yum源为清华源
- hosts: es_master
  roles:
    - role: elastic.elasticsearch
  vars:
    es_heap_size: "30g"
    es_api_host: "{{ansible_ssh_host}}"
    es_data_dirs:
      - "/opt/elasticsearch/data"
    es_log_dir: "/opt/elasticsearch/logs"
    es_config:
      cluster.name: "suncar-es"
      node.name: "{{inventory_hostname}}"
      network.host: "{{ansible_ssh_host}}"
      cluster.initial_master_nodes: ["172.16.91.227", "172.16.91.66", "172.16.91.73"]
      discovery.seed_hosts: ["172.16.91.227:9300", "172.16.91.66:9300", "172.16.91.73:9300"]
      http.port: 9200
      node.master: true
      node.data: false
      bootstrap.memory_lock: true
      gateway.recover_after_nodes: 2
      xpack.monitoring.collection.enabled: true
      http.cors.enabled: true
      http.cors.allow-origin: "*"

- hosts: es_data
  roles:
    - role: elastic.elasticsearch
  vars:
    es_heap_size: "30g"
    es_api_host: "{{ansible_ssh_host}}"
    es_data_dirs:
      - "/opt/elasticsearch/data"
    es_log_dir: "/opt/elasticsearch/logs"
    es_config:
      cluster.name: "suncar-es"
      node.name: "{{inventory_hostname}}"
      network.host: "{{ansible_ssh_host}}"
      cluster.initial_master_nodes: ["172.16.91.227", "172.16.91.66", "172.16.91.73"]
      discovery.seed_hosts: ["172.16.91.227:9300", "172.16.91.66:9300", "172.16.91.73:9300"]
      http.port: 9200
      node.master: false
      node.data: true
      bootstrap.memory_lock: true
      gateway.recover_after_nodes: 2
      xpack.monitoring.collection.enabled: true
      http.cors.enabled: true
      http.cors.allow-origin: "*"

- hosts: es_ingest
  roles:
    - role: elastic.elasticsearch
  vars:
    es_heap_size: "30g"
    es_api_host: "{{ansible_ssh_host}}"
    es_data_dirs:
      - "/opt/elasticsearch/data"
    es_log_dir: "/opt/elasticsearch/logs"
    es_config:
      cluster.name: "suncar-es"
      node.name: "{{inventory_hostname}}"
      network.host: "{{ansible_ssh_host}}"
      cluster.initial_master_nodes: ["172.16.91.227", "172.16.91.66", "172.16.91.73"]
      discovery.seed_hosts: ["172.16.91.227:9300", "172.16.91.66:9300", "172.16.91.73:9300"]
      http.port: 9200
      node.master: false
      node.data: false
      bootstrap.memory_lock: true
      gateway.recover_after_nodes: 2
      xpack.monitoring.collection.enabled: true
      http.cors.enabled: true
      http.cors.allow-origin: "*"
```

```bash
# 修改roles文件，修改yum源为清华源
cat /etc/ansible/roles/elastic.elasticsearch/templates/elasticsearch.repo
```

```
[elasticsearch-7.x]
name=Elasticsearch repository for 7.x packages
baseurl=https://mirrors.tuna.tsinghua.edu.cn/elasticstack/yum/elastic-7.x/
gpgcheck=0
enabled=1
```

```bash
# 修改es yml配置文件,将安全功能开启，并自己设置密码
cat /etc/ansible/roles/elastic.elasticsearch/templates/elasticsearch.yml.j2
```

```
{% if es_enable_xpack and es_api_basic_auth_username is defined and es_api_basic_auth_password is defined %}   #将这一行改为下面
{% if es_enable_xpack %}
```



```bash
# 安装
ansible-playbook es.yml
```

```bash
# ansible安装完成后，初始化es通信的密码
export JAVA_HOME=/usr/share/elasticsearch/jdk/
cd /usr/share/elasticsearch/
bin/elasticsearch-setup-passwords interactive
```

