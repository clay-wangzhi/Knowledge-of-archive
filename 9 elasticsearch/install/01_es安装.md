## ansible配置

```bash
# 修改主机名
hostnamectl set-hostname elk_ans
# 生产密钥对，生成后将公钥导入到私有云主机中，创建新主机时使用
ssh-keygen 
```

```bash
# yum 安装
yum -y install ansible
# 修改主机列表为yaml格式
mv /etc/ansible/hosts{,.yml}
# 优化配置
egrep -v "^$|^#" /etc/ansible/ansible.cfg
```

```
[defaults]
inventory      = /etc/ansible/hosts.yml
roles_path    = /etc/ansible/roles
host_key_checking = False
deprecation_warnings = False
retry_files_enabled = False
[ssh_connection]
ssh_args = -C -o ControlMaster=auto -o ControlPersist=5d
```

## 安装Elasticsearch

```bash
# 下载roles
ansible-galaxy install elastic.elasticsearch,7.7.1
# 编写ansible主机清单
cat /etc/ansible/hosts.yml 
```

```
all:
  children:
    elasticsearch:
      children:
        es_master:
        es_data:
        es_ingest:
    es_master:
      hosts:
        es_master1:
          ansible_ssh_host: 172.16.91.227
        es_master2:
          ansible_ssh_host: 172.16.91.66
        es_master3:
          ansible_ssh_host: 172.16.91.73
    es_data:
      hosts:
        es_data1:
          ansible_ssh_host: 172.16.91.119
        es_data2:
          ansible_ssh_host: 172.16.91.85
        es_data3:
          ansible_ssh_host: 172.16.91.229
    es_ingest:
      hosts:
        es_ingest1:
          ansible_ssh_host: 172.16.91.27
        es_ingest2:
          ansible_ssh_host: 172.16.91.1
        es_ingest3:
          ansible_ssh_host: 172.16.91.151
```

```bash
# 编写playbook
cat /etc/ansible/playbook/es.yml 
```

```bash
---
# 注意修改yum源为清华源
- hosts: es_master
  roles:
    - role: elastic.elasticsearch
  vars:
    es_heap_size: "30g"
    es_api_host: "{{ansible_ssh_host}}"
    es_data_dirs:
      - "/opt/elasticsearch/data"
    es_log_dir: "/opt/elasticsearch/logs"
    es_config:
      cluster.name: "suncar-es"
      node.name: "{{inventory_hostname}}"
      network.host: "{{ansible_ssh_host}}"
      cluster.initial_master_nodes: ["172.16.91.227", "172.16.91.66", "172.16.91.73"]
      discovery.seed_hosts: ["172.16.91.227:9300", "172.16.91.66:9300", "172.16.91.73:9300"]
      http.port: 9200
      node.master: true
      node.data: false
      bootstrap.memory_lock: true
      gateway.recover_after_nodes: 2
      xpack.monitoring.collection.enabled: true
      http.cors.enabled: true
      http.cors.allow-origin: "*"

- hosts: es_data
  roles:
    - role: elastic.elasticsearch
  vars:
    es_heap_size: "30g"
    es_api_host: "{{ansible_ssh_host}}"
    es_data_dirs:
      - "/opt/elasticsearch/data"
    es_log_dir: "/opt/elasticsearch/logs"
    es_config:
      cluster.name: "suncar-es"
      node.name: "{{inventory_hostname}}"
      network.host: "{{ansible_ssh_host}}"
      cluster.initial_master_nodes: ["172.16.91.227", "172.16.91.66", "172.16.91.73"]
      discovery.seed_hosts: ["172.16.91.227:9300", "172.16.91.66:9300", "172.16.91.73:9300"]
      http.port: 9200
      node.master: false
      node.data: true
      bootstrap.memory_lock: true
      gateway.recover_after_nodes: 2
      xpack.monitoring.collection.enabled: true
      http.cors.enabled: true
      http.cors.allow-origin: "*"

- hosts: es_ingest
  roles:
    - role: elastic.elasticsearch
  vars:
    es_heap_size: "30g"
    es_api_host: "{{ansible_ssh_host}}"
    es_data_dirs:
      - "/opt/elasticsearch/data"
    es_log_dir: "/opt/elasticsearch/logs"
    es_config:
      cluster.name: "suncar-es"
      node.name: "{{inventory_hostname}}"
      network.host: "{{ansible_ssh_host}}"
      cluster.initial_master_nodes: ["172.16.91.227", "172.16.91.66", "172.16.91.73"]
      discovery.seed_hosts: ["172.16.91.227:9300", "172.16.91.66:9300", "172.16.91.73:9300"]
      http.port: 9200
      node.master: false
      node.data: false
      bootstrap.memory_lock: true
      gateway.recover_after_nodes: 2
      xpack.monitoring.collection.enabled: true
      http.cors.enabled: true
      http.cors.allow-origin: "*"
```

```bash
# 修改roles文件，修改yum源为清华源
cat /etc/ansible/roles/elastic.elasticsearch/templates/elasticsearch.repo
```

```
[elasticsearch-7.x]
name=Elasticsearch repository for 7.x packages
baseurl=https://mirrors.tuna.tsinghua.edu.cn/elasticstack/yum/elastic-7.x/
gpgcheck=0
enabled=1
```

```bash
# 修改es yml配置文件,将安全功能开启，并自己设置密码
cat /etc/ansible/roles/elastic.elasticsearch/templates/elasticsearch.yml.j2
```

```
{% if es_enable_xpack and es_api_basic_auth_username is defined and es_api_basic_auth_password is defined %}   #将这一行改为下面
{% if es_enable_xpack %}
```



```bash
# 安装
ansible-playbook es.yml
```

```bash
# ansible安装完成后，初始化es通信的密码
export JAVA_HOME=/usr/share/elasticsearch/jdk/
cd /usr/share/elasticsearch/
bin/elasticsearch-setup-passwords interactive
```

### 配置Node间SSL

注意：这里是指配置ES集群节点间transport的SSL认证，对于ES节点的HTTP API接口并没有配置，所以通过API访问ES时不需要提供证书。

参考官网:

https://www.elastic.co/guide/en/elasticsearch/reference/current/ssl-tls.html

https://www.elastic.co/guide/en/elasticsearch/reference/7.4/configuring-tls.html

创建SSL/TLS证书：

```
cd /usr/share/elasticsearch/
export JAVA_HOME=/usr/share/elasticsearch/jdk/
./elasticsearch-certutil ca -v   //一路回车
cd ..
./bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12  //一路回车
mv elastic-* /etc/elasticsearch/
cd /etc/elasticsearch/
chown elasticsearch.elasticsearch *.p12
```

`vim /etc/elasticsearch/elasticsearch.yml`

* 增加下面四行

```
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: /etc/elasticsearch/elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: /etc/elasticsearch/elastic-certificates.p12
```

重启es

```
systemctl restart elasticsearch.service 
```

操作完成后，把证书传到剩余节点，修改剩余节点的配置文件，并重启

> 在此过程中，所有节点必须全部更新完，否则之前的用户名和密码将会认证失败
>
> 更新完成之后，集群的健康检查为yellow，不要着急，等待它自己自动恢复成green，当es中数据较多时会出现